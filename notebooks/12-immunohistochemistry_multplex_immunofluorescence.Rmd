---
title: "immunohistochemistry_multplex_immunofluorescence"
output: html_document
---

Run this notebook to generate

-   Figure 2c

-   Extended Data Figure 5a-j

-   Extended Data Figure 8b (right) and 8d (right)

This script analyzes HLA Class I/II protein expression and T-cell density, examining their associations with Verhaak transcriptional subtypes.

-   mIF data: Per-cell HLA-I and HLA-II protein expression.

-   IHC data: CD3+ T-cell density.

# Load data

```{r}
library(openxlsx)
library(readxl)
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(purrr)
library(patchwork)

zenodo_dir_path <- '../data/IHC_mIF_data'

clinical_data <- read_csv(file.path(zenodo_dir_path, "Clinical_Data_Samples.csv"), show_col_types = FALSE)
raw_class_i_cells <- read_csv(file.path(zenodo_dir_path, "Raw_Class_I_Cells_Samples.csv"), show_col_types = FALSE)
raw_class_ii_cells <- read_csv(file.path(zenodo_dir_path, "Raw_Class_II_Cells_Samples.csv"), show_col_types = FALSE)
```

# Data processing: categorize HLA expression

This chunk contains logic to define HLA thresholds, classify cells, and calculate per-sample metrics.

```{r}
#PROCESS HLA CLASS I DATA
hla_values_i <- raw_class_i_cells$hla_cell
hla_clean_i <- hla_values_i[!is.na(hla_values_i)]
overall_mean_i <- mean(hla_clean_i)
overall_sd_i <- sd(hla_clean_i)
lower_quartile_i <- quantile(hla_clean_i, 0.25, na.rm = TRUE)
background_subset_i <- hla_clean_i[hla_clean_i <= lower_quartile_i]
THRESHOLD_NEGATIVE_I <- mean(background_subset_i) + 2 * sd(background_subset_i)
THRESHOLD_LOW_END_I <- overall_mean_i + 1.5 * overall_sd_i
THRESHOLD_MEDIUM_END_I <- overall_mean_i + 3.0 * overall_sd_i

qupath_classified_i <- raw_class_i_cells %>%
  mutate(
    hla_category = factor(case_when(
      hla_cell >= THRESHOLD_MEDIUM_END_I ~ "High",
      hla_cell >= THRESHOLD_LOW_END_I   ~ "Medium",
      hla_cell >= THRESHOLD_NEGATIVE_I  ~ "Low",
      TRUE                              ~ "Negative"
    ), levels = c("Negative", "Low", "Medium", "High"))
  )

calculate_hla_metrics <- function(df) {
  df %>%
    group_by(key_join, block, base_core, key_meas) %>%
    summarise(
      percent_negative = (sum(hla_category == "Negative") / n()) * 100,
      percent_low = (sum(hla_category == "Low") / n()) * 100,
      percent_medium = (sum(hla_category == "Medium") / n()) * 100,
      percent_high = (sum(hla_category == "High") / n()) * 100,
      .groups = "drop"
    )
}

metrics_overall_i <- calculate_hla_metrics(qupath_classified_i) %>% mutate(Classification = "Overall")
metrics_by_sox2_i <- qupath_classified_i %>% group_by(Classification) %>% do(calculate_hla_metrics(.)) %>% ungroup()
all_metrics_i <- bind_rows(metrics_overall_i, metrics_by_sox2_i) %>% 
  filter(Classification %in% c("Overall", "SOX2 High", "SOX2 Low"))

#PROCESS HLA CLASS II DATA
hla_values_ii <- raw_class_ii_cells$hla_cell
hla_clean_ii <- hla_values_ii[!is.na(hla_values_ii)]
overall_mean_ii <- mean(hla_clean_ii)
overall_sd_ii <- sd(hla_clean_ii)
lower_quartile_ii <- quantile(hla_clean_ii, 0.25, na.rm = TRUE)
background_subset_ii <- hla_clean_ii[hla_clean_ii <= lower_quartile_ii]
THRESHOLD_NEGATIVE_II <- mean(background_subset_ii) + 2 * sd(background_subset_ii)
THRESHOLD_LOW_END_II <- overall_mean_ii + 1.5 * overall_sd_ii
THRESHOLD_MEDIUM_END_II <- overall_mean_ii + 3.0 * overall_sd_ii

qupath_classified_ii <- raw_class_ii_cells %>%
  mutate(
    hla_category = factor(case_when(
      hla_cell >= THRESHOLD_MEDIUM_END_II ~ "High",
      hla_cell >= THRESHOLD_LOW_END_II   ~ "Medium",
      hla_cell >= THRESHOLD_NEGATIVE_II  ~ "Low",
      TRUE                               ~ "Negative"
    ), levels = c("Negative", "Low", "Medium", "High"))
  )

metrics_overall_ii <- calculate_hla_metrics(qupath_classified_ii) %>% mutate(Classification = "Overall")
metrics_by_sox2_ii <- qupath_classified_ii %>% group_by(Classification) %>% do(calculate_hla_metrics(.)) %>% ungroup()
all_metrics_ii <- bind_rows(metrics_overall_ii, metrics_by_sox2_ii) %>% 
  filter(Classification %in% c("Overall", "SOX2 High", "SOX2 Low"))

# PREPARE FINAL DATA OBJECTS
final_summary_keys <- clinical_data %>%
  rename(
    cd3_density = any_of(grep("Total CD3\\+ Density.*cells/mm", names(.), value = TRUE)[1]),
    hla_classII_ssgsea = any_of("GOCC_MHC_CLASS_II_PROTEIN_COMPLEX"),
    hla_classI_ssgsea = any_of("GOCC_MHC_CLASS_I_PROTEIN_COMPLEX")
  ) %>%
  mutate(
    mes_group = if_else(str_to_title(verhaak_subtype) == "Mesenchymal", "MES", "Non-MES")
  )

combined_data_i <- all_metrics_i %>% 
  left_join(final_summary_keys, by = c("key_join" = "key_meta"))

combined_data_ii <- all_metrics_ii %>% 
  left_join(final_summary_keys, by = c("key_join" = "key_meta")) %>%
  mutate(percent_medium_high = percent_medium + percent_high)

verhaak_comparisons_all <- list(
  c("Mesenchymal", "Classical"), c("Mesenchymal", "Neural"), 
  c("Mesenchymal", "Proneural"), c("Classical", "Neural"),
  c("Classical", "Proneural"), c("Neural", "Proneural")
)
verhaak_comparisons_mes_only <- list(
  c("Mesenchymal", "Classical"), c("Mesenchymal", "Neural"), 
  c("Mesenchymal", "Proneural")
)
verhaak_comparisons_2way <- list(c("MES", "Non-MES"))

subtype_order <- c("Mesenchymal", "Classical", "Neural", "Proneural")
plot_colors <- c("Mesenchymal" = "#d62728", "Classical" = "#F69351", "Neural" = "#94A3AF", "Proneural" = "#1f77b4")

create_score_scatter <- function(data, x_var, y_var, x_label, y_label, title, subtitle, facet_var = ~Classification, point_color = "black") {
  data_filtered <- data %>% filter(!is.na(!!sym(x_var)), !is.na(!!sym(y_var)))
  if(nrow(data_filtered) < 5) return(NULL)
  
  p <- ggplot(data_filtered, aes_string(x = x_var, y = y_var)) +
    geom_point(alpha = 0.8, color = point_color) + 
    geom_smooth(method = "lm", se = TRUE, color = "black") +
    stat_cor(method = "spearman", label.x.npc = 0.05, label.y.npc = 0.95, size = 5) +
    labs(title = title, subtitle = subtitle, x = x_label, y = y_label) +
    theme_classic(base_size = 14) + 
    theme(strip.background = element_rect(fill="grey90", color = NA))
  
  if (!is.null(facet_var)) {
    p <- p + facet_wrap(facet_var, scales = "free")
  }
  return(p)
}
```

# Figure 2c

Compares the percentage of HLA class I-high malignant (SOX2 High) cells across the four Verhaak subtypes.

```{r}
plot_data_2c <- combined_data_i %>%
  filter(Classification == "SOX2 High", !is.na(verhaak_subtype)) %>%
  mutate(verhaak_subtype = str_to_title(verhaak_subtype))

plot_data_2c$verhaak_subtype <- factor(plot_data_2c$verhaak_subtype, levels = subtype_order)

p_2c <- ggplot(plot_data_2c, aes(x = verhaak_subtype, y = percent_high)) +
  geom_boxplot(aes(fill = verhaak_subtype), outlier.shape = NA) +
  geom_jitter(width = 0.15, height = 0, alpha = 0.7, color = "black") +
  scale_fill_manual(values = plot_colors) +
  stat_compare_means(comparisons = verhaak_comparisons_all, method = "wilcox.test", label = "p.format", size = 3) +
  theme_classic(base_size = 14) +
  labs(title = "HLA Class I-High in Malignant (SOX2High) Cells",
       x = NULL, y = "% HLA-I-High Cells") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1))

print(p_2c)
```

# Extended Data Fig. 5a

Compares CD3+ T-cell density across the four Verhaak transcriptional subtypes.

```{r}
plot_data_5a <- final_summary_keys %>%
  filter(!is.na(verhaak_subtype), !is.na(cd3_density)) %>%
  mutate(verhaak_subtype = str_to_title(verhaak_subtype))

plot_data_5a$verhaak_subtype <- factor(plot_data_5a$verhaak_subtype, levels = subtype_order)

p_5a <- ggplot(plot_data_5a, aes(x = verhaak_subtype, y = cd3_density)) +
  geom_boxplot(aes(fill = verhaak_subtype), outlier.shape = NA) +
  geom_jitter(width = 0.15, height = 0, alpha = 0.7, color = "black") +
  scale_fill_manual(values = plot_colors) +
  stat_compare_means(comparisons = verhaak_comparisons_all, method = "wilcox.test", label = "p.format", size = 3) +
  theme_classic(base_size = 14) +
  labs(title = "CD3+ T-Cell Density Across Verhaak Subtypes", 
       x = NULL, y = "CD3+ T-Cell Density (cells/mm²)") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1))

print(p_5a)
```

# Extended Data Fig. 5b

Correlates the Verhaak MES signature score with CD3+ T-cell density for all samples.

```{r}
p_5b <- create_score_scatter(
  data = final_summary_keys,
  x_var = "VERHAAK_GLIOBLASTOMA_MESENCHYMAL",
  y_var = "cd3_density",
  x_label = "Verhaak Mesenchymal Score",
  y_label = "CD3+ T-Cell Density (cells/mm²)",
  title = "CD3+ T-Cell Density vs. Mesenchymal Score",
  subtitle = "Spearman Correlation (n=36 samples)",
  facet_var = NULL,
  point_color = "#3182bd"
)
if(!is.null(p_5b)) {
  print(p_5b)
}
```

# Extended Data Fig. 5c

Compares the percentage of HLA class I-high cells in both malignant (SOX2 High) and non-malignant (SOX2 Low) compartments between MES and non-MES tumors.

```{r}
plot_data_5c <- combined_data_i %>%
  filter(Classification %in% c("SOX2 High", "SOX2 Low")) %>%
  mutate(Compartment = if_else(Classification == "SOX2 High", "Malignant (SOX2High)", "Non-Malignant (SOX2Low)"))

p_5c <- ggplot(plot_data_5c, aes(x = mes_group, y = percent_high, fill = mes_group)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(width = 0.1, alpha = 0.7) +
  facet_wrap(~ Compartment, scales = "free_y") +
  stat_compare_means(method = "wilcox.test", comparisons = verhaak_comparisons_2way, label = "p.format") +
  scale_fill_manual(values = c("MES" = "#d62728", "Non-MES" = "#1f77b4")) +
  labs(title = "HLA Class I-High Cells (MES vs. Non-MES)", 
       x = "Verhaak Subtype Group", y = "% HLA-I-High Cells") +
  theme_classic(base_size = 14) + 
  theme(legend.position = "none", 
        strip.background = element_rect(fill="grey90", color = NA))

print(p_5c)
```

# Extended Data Fig. 5d

Compares the percentage of HLA class I-high non-malignant (SOX2 Low) cells across the four Verhaak subtypes.

```{r}
plot_data_5d <- combined_data_i %>%
  filter(Classification == "SOX2 Low", !is.na(verhaak_subtype)) %>%
  mutate(verhaak_subtype = str_to_title(verhaak_subtype))

plot_data_5d$verhaak_subtype <- factor(plot_data_5d$verhaak_subtype, levels = subtype_order)

p_5d <- ggplot(plot_data_5d, aes(x = verhaak_subtype, y = percent_high)) +
  geom_boxplot(aes(fill = verhaak_subtype), outlier.shape = NA) +
  geom_jitter(width = 0.15, height = 0, alpha = 0.7, color = "black") +
  scale_fill_manual(values = plot_colors) +
  stat_compare_means(comparisons = verhaak_comparisons_all, method = "wilcox.test", label = "p.format", size = 3) +
  theme_classic(base_size = 14) +
  labs(title = "HLA Class I-High in Non-Malignant (SOX2Low) Cells",
       x = NULL, y = "% HLA-I-High Cells") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1))

print(p_5d)
```

# Extended Data Fig. 5e

Compares the percentage of HLA class II-medium/high cells in both malignant (SOX2 High) and non-malignant (SOX2Low) compartments between MES and non-MES tumors.

```{r}
plot_data_5e <- combined_data_ii %>%
  filter(Classification %in% c("SOX2 High", "SOX2 Low")) %>%
  mutate(Compartment = if_else(Classification == "SOX2 High", "Malignant (SOX2High)", "Non-Malignant (SOX2Low)"))

p_5e <- ggplot(plot_data_5e, aes(x = mes_group, y = percent_medium_high, fill = mes_group)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(width = 0.1, alpha = 0.7) +
  facet_wrap(~ Compartment, scales = "free_y") +
  stat_compare_means(method = "wilcox.test", comparisons = verhaak_comparisons_2way, label = "p.format") +
  scale_fill_manual(values = c("MES" = "#d62728", "Non-MES" = "#1f77b4")) +
  labs(title = "HLA Class II-Medium/High Cells (MES vs. Non-MES)", 
       x = "Verhaak Subtype Group", y = "% HLA-II-Medium/High Cells") +
  theme_classic(base_size = 14) + 
  theme(legend.position = "none", 
        strip.background = element_rect(fill="grey90", color = NA))

print(p_5e)
```

# Extended Data Fig. 5f

Compares the percentage of HLA class II-medium/high cells in both malignant (SOX2 High) and non-malignant (SOX2Low) compartments across the four Verhaak subtypes.

```{r}
plot_data_5f <- combined_data_ii %>%
  filter(Classification %in% c("SOX2 High", "SOX2 Low"), !is.na(verhaak_subtype)) %>%
  mutate(verhaak_subtype = str_to_title(verhaak_subtype),
         Compartment = if_else(Classification == "SOX2 High", "Malignant (SOX2High)", "Non-Malignant (SOX2Low)"))

plot_data_5f$verhaak_subtype <- factor(plot_data_5f$verhaak_subtype, levels = subtype_order)

p_5f <- ggplot(plot_data_5f, aes(x = verhaak_subtype, y = percent_medium_high)) +
  geom_boxplot(aes(fill = verhaak_subtype), outlier.shape = NA) +
  geom_jitter(width = 0.15, height = 0, alpha = 0.7, color = "black") +
  facet_wrap(~ Compartment, scales = "free_y") +
  scale_fill_manual(values = plot_colors) +
  stat_compare_means(comparisons = verhaak_comparisons_all, method = "wilcox.test", label = "p.format", size = 3) +
  theme_classic(base_size = 14) +
  labs(title = "HLA Class II-Medium/High Cells by Verhaak Subtype",
       x = NULL, y = "% HLA-II-Medium/High Cells") +
  theme(legend.position = "none", 
        strip.background = element_rect(fill="grey90", color = NA),
        axis.text.x = element_text(angle = 45, hjust = 1))

print(p_5f)
```

# Extended Data Fig. 5g

Correlates the Verhaak MES ssGSEA score with the percentage of HLA class I-high cells in both malignant and non-malignant compartments.

```{r}
p_5g <- create_score_scatter(
  data = combined_data_i %>% filter(Classification != "Overall"),
  x_var = "VERHAAK_GLIOBLASTOMA_MESENCHYMAL",
  y_var = "percent_high",
  x_label = "Verhaak Mesenchymal Score",
  y_label = "% HLA-I-High Cells",
  title = "HLA Class I-High Cells vs. Mesenchymal Score",
  subtitle = "Faceted by SOX2 Classification (Spearman Correlation)",
  facet_var = ~ Classification,
  point_color = "#d62728"
)
if(!is.null(p_5g)) {
  print(p_5g)
}
```

# Extended Data Fig. 5h

Correlates the Verhaak MES ssGSEA score with the percentage of HLA class II-medium/high cells in both malignant and non-malignant compartments.

```{r}
p_5h <- create_score_scatter(
  data = combined_data_ii %>% filter(Classification != "Overall"),
  x_var = "VERHAAK_GLIOBLASTOMA_MESENCHYMAL",
  y_var = "percent_medium_high",
  x_label = "Verhaak Mesenchymal Score",
  y_label = "% HLA-II-Medium/High Cells",
  title = "HLA Class II-Medium/High Cells vs. Mesenchymal Score",
  subtitle = "Faceted by SOX2 Classification (Spearman Correlation)",
  facet_var = ~ Classification,
  point_color = "#9467bd"
)
if(!is.null(p_5h)) {
  print(p_5h)
}
```

# Extended Data Fig. 5i

Correlates the Verhaak PN ssGSEA score with both HLA class I-high and class II-medium/high cells within the malignant (SOX2 High) compartment.

```{r}
data_5i_i <- combined_data_i %>% 
  filter(Classification == "SOX2 High")

data_5i_ii <- combined_data_ii %>% 
  filter(Classification == "SOX2 High")

p_5i_left <- create_score_scatter(
  data = data_5i_i,
  x_var = "VERHAAK_GLIOBLASTOMA_PRONEURAL",
  y_var = "percent_high",
  x_label = "Verhaak Proneural Score",
  y_label = "% HLA-I-High Cells",
  title = "HLA-I-High (Malignant) vs. Proneural Score",
  subtitle = "Spearman Correlation (SOX2High)",
  facet_var = NULL,
  point_color = "#d62728"
)

p_5i_right <- create_score_scatter(
  data = data_5i_ii,
  x_var = "VERHAAK_GLIOBLASTOMA_PRONEURAL",
  y_var = "percent_medium_high",
  x_label = "Verhaak Proneural Score",
  y_label = "% HLA-II-Medium/High Cells",
  title = "HLA-II-Med/High (Malignant) vs. Proneural Score",
  subtitle = "Spearman Correlation (SOX2High)",
  facet_var = NULL,
  point_color = "#9467bd"
)

if(!is.null(p_5i_left) & !is.null(p_5i_right)) {
  print(p_5i_left + p_5i_right)
}
```

# Extended Data Fig. 5j

Correlates CD3+ T-cell density with both HLA class I-high and class II-medium/high cells within the malignant (SOX2 High) compartment.

```{r}
data_5j_i <- combined_data_i %>% 
  filter(Classification == "SOX2 High")

data_5j_ii <- combined_data_ii %>% 
  filter(Classification == "SOX2 High")

p_5j_left <- create_score_scatter(
  data = data_5j_i,
  x_var = "cd3_density",
  y_var = "percent_high",
  x_label = "CD3+ T-Cell Density (cells/mm²)",
  y_label = "% HLA-I-High Cells",
  title = "HLA-I-High (Malignant) vs. T-Cell Density",
  subtitle = "Spearman Correlation (SOX2High)",
  facet_var = NULL,
  point_color = "#d62728"
)

p_5j_right <- create_score_scatter(
  data = data_5j_ii,
  x_var = "cd3_density",
  y_var = "percent_medium_high",
  x_label = "CD3+ T-Cell Density (cells/mm²)",
  y_label = "% HLA-II-Medium/High Cells",
  title = "HLA-II-Med/High (Malignant) vs. T-Cell Density",
  subtitle = "Spearman Correlation (SOX2High)",
  facet_var = NULL,
  point_color = "#9467bd"
)

if(!is.null(p_5j_left) & !is.null(p_5j_right)) {
  print(p_5j_left + p_5j_right)
}
```

# Extended Data Fig. 8b (right)

Calculate fraction of HLA class II signal from malignant cells.

```{r}
signal_fraction_i <- qupath_classified_i %>%
  group_by(key_join) %>%
  summarise(
    signal_malig = sum(hla_cell[Classification == "SOX2 High"], na.rm = TRUE),
    signal_total = sum(hla_cell, na.rm = TRUE),
    hla_signal_fraction_malig = signal_malig / signal_total,
    .groups = "drop"
  ) %>%
  left_join(final_summary_keys, by = c("key_join" = "key_meta")) %>%
  filter(!is.na(mes_group))

p_8b_right <- ggplot(signal_fraction_i, aes(x = mes_group, y = hla_signal_fraction_malig, fill = mes_group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, alpha = 0.7) +
  stat_compare_means(method = "wilcox.test", comparisons = verhaak_comparisons_2way, label = "p.format") +
  scale_fill_manual(values = c("MES" = "#d62728", "Non-MES" = "#1f77b4")) +
  labs(title = "HLA Class I Signal from Malignant Cells",
       subtitle = "MES vs. Non-MES Tumors",
       x = "Verhaak Subtype Group", 
       y = "Fraction of Total HLA-I Signal\nfrom Malignant Cells") +
  theme_classic(base_size = 14) +
  theme(legend.position = "none")

print(p_8b_right)
```

# Extended Data Fig. 8d (right)

Calculate fraction of HLA class II signal from malignant cells.

```{r}
signal_fraction_ii <- qupath_classified_ii %>%
  group_by(key_join) %>%
  summarise(
    signal_malig = sum(hla_cell[Classification == "SOX2 High"], na.rm = TRUE),
    signal_total = sum(hla_cell, na.rm = TRUE),
    hla_signal_fraction_malig = signal_malig / signal_total,
    .groups = "drop"
  ) %>%
  left_join(final_summary_keys, by = c("key_join" = "key_meta")) %>%
  filter(!is.na(mes_group))

p_9d_right <- ggplot(signal_fraction_ii, aes(x = mes_group, y = hla_signal_fraction_malig, fill = mes_group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1, alpha = 0.7) +
  stat_compare_means(method = "wilcox.test", comparisons = verhaak_comparisons_2way, label = "p.format") +
  scale_fill_manual(values = c("MES" = "#d62728", "Non-MES" = "#1f77b4")) +
  labs(title = "HLA Class II Signal from Malignant Cells",
       subtitle = "MES vs. Non-MES Tumors",
       x = "Verhaak Subtype Group", 
       y = "Fraction of Total HLA-II Signal\nfrom Malignant Cells") +
  theme_classic(base_size = 14) +
  theme(legend.position = "none")

print(p_9d_right)
```
